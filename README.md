# Автоматическое резервное копирование PostgreSQL из Docker

Скрипт для автоматического резервного копирования баз данных PostgreSQL, работающих в Docker-контейнерах. Он создает сжатые дампы всех баз данных, ротирует старые бэкапы и ведет подробный лог своей работы.

## Особенности

*   **Работа с несколькими контейнерами:** Позволяет указать список контейнеров для бэкапа.
*   **Эффективное сжатие:** Использует `zstd` для быстрого и сильного сжатия бэкапов.
*   **Автоматическая очистка:** Удаляет бэкапы старше заданного количества дней (`DAYS_TO_KEEP`).
*   **Подробное логирование:** Все операции, включая ошибки и статистику, записываются в лог-файл.
*   **Проверки перед бэкапом:** Убеждается, что контейнер запущен и PostgreSQL в нем готов к работе.
*   **Надёжность:** Проверяет, что созданный файл бэкапа не пустой. Завершается с кодом ошибки, если хотя бы один бэкап не удался, что удобно для систем мониторинга.

## Требования

*   `docker`
*   `zstd` (утилита для сжатия)

Чтобы установить `zstd` в Debian/Ubuntu:
```bash
sudo apt-get update && sudo apt-get install zstd
```

## Настройка

Все основные параметры настраиваются в начале файла `docker_pg_dump.sh`:

*   `CONTAINER_NAMES`: Массив с именами ваших Docker-контейнеров, в которых работает PostgreSQL.
    ```bash
    CONTAINER_NAMES=("remnawave-db" "remnawave-tg-shop-db-trib")
    ```
*   `DB_USER`: Имя пользователя PostgreSQL для подключения.
    ```bash
    DB_USER="postgres"
    ```
*   `BACKUP_DIR`: Директория для хранения бэкапов и лог-файла.
    ```bash
    BACKUP_DIR="/opt/r2_backup/pg_backups"
    ```
*   `DAYS_TO_KEEP`: Количество дней, в течение которых нужно хранить бэкапы.
    ```bash
    DAYS_TO_KEEP=7
    ```

## Использование

1.  **Сделайте скрипт исполняемым:**
    ```bash
    chmod +x docker_pg_dump.sh
    ```

2.  **Запустите вручную для проверки:**
    ```bash
    ./docker_pg_dump.sh
    ```

## Автоматизация с помощью Cron

Для регулярного автоматического запуска добавьте задание в `cron`.

1.  Откройте редактор crontab:
    ```bash
    crontab -e
    ```

2.  Добавьте строку, указав полный путь к скрипту. Например, для запуска каждый день в 03:05 ночи:
    ```
    # Запускать бэкап PostgreSQL каждый день в 03:05
    5 3 * * * /opt/r2_backup/docker_pg_dump.sh
    ```
    *Скрипт сам перенаправляет вывод в свой лог-файл, поэтому `>> /path/to/log 2>&1` не требуется.*

## Просмотр логов

Логи работы скрипта можно найти в файле `backup.log` внутри директории, указанной в `BACKUP_DIR`.

Для просмотра лога в реальном времени:
```bash
tail -f /opt/r2_backup/pg_backups/backup.log
```

## Восстановление из бэкапа

Для восстановления данных из сжатого бэкапа выполните команду, подставив имя вашего контейнера и путь к файлу бэкапа:

```bash
zstdcat /opt/r2_backup/pg_backups/ИМЯ_ФАЙЛА_БЭКАПА.sql.zst | docker exec -i ИМЯ_ВАШЕГО_КОНТЕЙНЕРА psql -U postgres
```
